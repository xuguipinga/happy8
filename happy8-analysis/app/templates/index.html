<!DOCTYPE html>

<html lang="zh-CN">



<head>

    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>å¿«ä¹8 æ™ºèƒ½åˆ†æå¤§å±</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

    <style>
        body {

            background-color: #f4f6f9;

        }



        .card {

            margin-bottom: 20px;

            border: none;

            shadow: 0 4px 6px rgba(0, 0, 0, 0.1);

        }



        .ball-hot {

            background: #ff4757;

            color: white;

        }



        .ball-cold {

            background: #ced6e0;

            color: #2f3542;

        }



        .trend-table td,

        .trend-table th {

            padding: 4px;

            border: 1px solid #dfe6e9;

            min-width: 25px;

        }



        .trend-ball-hit {

            width: 20px;

            height: 20px;

            line-height: 20px;

            border-radius: 50%;

            background: #ff4757;

            color: white;

            display: inline-block;

            font-weight: bold;

            font-size: 12px;

        }



        .trend-omission {

            color: #b2bec3;

            font-size: 12px;

        }



        .trend-predict-hit {

            width: 20px;

            height: 20px;

            line-height: 18px;

            border-radius: 50%;

            border: 2px solid #2ed573;

            color: #2ed573;

            display: inline-block;

            font-weight: bold;

            font-size: 12px;

        }



        .card-header {

            background-color: #fff;

            border-bottom: 1px solid #eee;

            font-weight: bold;

        }



        .ball {

            display: inline-block;

            width: 30px;

            height: 30px;

            line-height: 30px;

            text-align: center;

            border-radius: 50%;

            background-color: #ff4757;

            color: #fff;

            margin: 2px;

            font-weight: bold;

            font-size: 14px;

        }



        .ball-hot {

            background-color: #ff4757;

        }



        .ball-cold {

            background-color: #535c68;

        }



        .stat-card {

            text-align: center;

            padding: 20px;

        }



        .stat-num {

            font-size: 24px;

            font-weight: bold;

            color: #d63031;

        }
    </style>

</head>



<body>

    <div class="container-fluid p-4">

        <div class="d-flex justify-content-between align-items-center mb-4">

            <h2 class="text-primary"><span class="badge bg-danger">LIVE</span> å¿«ä¹8 é€‰å·åˆ†æå¤§å±</h2>

            <div class="d-flex align-items-center">

                <span class="me-2 fw-bold">åˆ†ææœŸæ•°:</span>

                <select id="periodCount" class="form-select me-2" style="width: 120px;">

                    <option value="30">æœ€è¿‘ 30 æœŸ</option>

                    <option value="50" selected>æœ€è¿‘ 50 æœŸ</option>

                    <option value="100">æœ€è¿‘ 100 æœŸ</option>

                </select>

                <button class="btn btn-primary" onclick="refreshData()">ğŸ”„ åˆ·æ–°æ•°æ®</button>

                <button class="btn btn-success ms-2" onclick="openManualInputModal()">âœï¸ æ‰‹åŠ¨å½•å…¥</button>

            </div>

        </div>



        <!-- æ¨èåŒºåŸŸ -->

        <div class="row">

            <div class="col-md-4">

                <div class="card">

                    <div class="card-header">ğŸ”¥ æå“èƒ†ç æ¨è</div>

                    <div class="card-body text-center">

                        <h4 class="mb-3">é‡ç‚¹å…³æ³¨åŒºé—´: <span id="hotZone" class="text-danger">--</span></h4>

                        <div id="recommendDan" class="mb-2">åŠ è½½ä¸­...</div>

                        <button class="btn btn-sm btn-primary mt-2"
                            onclick="copyRecommendation('å¿«ä¹8', 'æå“èƒ†ç ', 'recommendDan')">ğŸ“‹ å¤åˆ¶èƒ†ç </button>

                        <br>

                        <small class="text-muted">*åŸºäºè¿‘æœŸçƒ­åŒº+çƒ­å·è®¡ç®—</small>

                    </div>

                </div>



                <!-- æ–°å¢ï¼šçƒ­å·åŒå‡ºåˆ†æå¡ç‰‡ -->

                <div class="card">

                    <div class="card-header">ğŸ¤ çƒ­å·åŒå‡ºåˆ†æ (Top 6)</div>

                    <div class="card-body">

                        <p class="mb-2">

                            <strong>æœ€çƒ­6ç :</strong>

                            <span id="topHotNums" class="text-primary fw-bold">--</span>

                        </p>

                        <div style="max-height: 200px; overflow-y: auto;">

                            <table class="table table-xs text-center" style="font-size: 12px;">

                                <thead class="table-light">

                                    <tr>

                                        <th>æœŸå·</th>

                                        <th>åŒå‡ºæ•°</th>

                                        <th>åŒå‡ºå·ç </th>

                                    </tr>

                                </thead>

                                <tbody id="coOccurTable">

                                    <tr>

                                        <td colspan="3">æš‚æ— æ•°æ®</td>

                                    </tr>

                                </tbody>

                            </table>

                        </div>

                    </div>

                </div>



                <!-- æ–°å¢ï¼šç©æ³•ä¸“é¡¹æ¨èå¡ç‰‡ -->

                <div class="card border-primary">

                    <div class="card-header bg-primary text-white">ğŸ† ç©æ³•ä¸“é¡¹æ¨è (çº¯çƒ­å·æµ)</div>

                    <div class="card-body">

                        <ul class="list-group list-group-flush">

                            <li class="list-group-item d-flex justify-content-between align-items-center">

                                <span><strong>é€‰å›› 3èƒ†å…¨æ‹–</strong> <span class="badge bg-warning text-dark">ç¨³</span></span>

                                <div>

                                    <span id="recPick4" class="fw-bold text-danger me-2">--</span>

                                    <button class="btn btn-sm btn-outline-primary"
                                        onclick="copyRecommendation('å¿«ä¹8', 'é€‰å›› 3èƒ†å…¨æ‹–', 'recPick4')">ğŸ“‹ å¤åˆ¶</button>

                                </div>

                            </li>

                            <li class="list-group-item d-flex justify-content-between align-items-center">

                                <span><strong>é€‰äº” 4èƒ†å…¨æ‹–</strong> <span class="badge bg-danger">ç«</span></span>

                                <div>

                                    <span id="recPick5Dan" class="fw-bold text-danger me-2">--</span>

                                    <button class="btn btn-sm btn-outline-primary"
                                        onclick="copyRecommendation('å¿«ä¹8', 'é€‰äº” 4èƒ†å…¨æ‹–', 'recPick5Dan')">ğŸ“‹ å¤åˆ¶</button>

                                </div>

                            </li>

                            <li class="list-group-item d-flex justify-content-between align-items-center">

                                <span><strong>é€‰äº” å•å¼/å¤å¼</strong></span>

                                <div>

                                    <span id="recPick5" class="fw-bold text-dark me-2">--</span>

                                    <button class="btn btn-sm btn-outline-primary"
                                        onclick="copyRecommendation('å¿«ä¹8', 'é€‰äº” å•å¼/å¤å¼', 'recPick5')">ğŸ“‹ å¤åˆ¶</button>

                                </div>

                            </li>

                            <li class="list-group-item d-flex justify-content-between align-items-center">

                                <span><strong>é€‰å…­ å•å¼/å¤å¼</strong></span>

                                <div>

                                    <span id="recPick6" class="fw-bold text-dark me-2">--</span>

                                    <button class="btn btn-sm btn-outline-primary"
                                        onclick="copyRecommendation('å¿«ä¹8', 'é€‰å…­ å•å¼/å¤å¼', 'recPick6')">ğŸ“‹ å¤åˆ¶</button>

                                </div>

                            </li>

                            <li class="list-group-item d-flex justify-content-between align-items-center">

                                <span><strong>é€‰ä¸ƒ å•å¼/å¤å¼</strong></span>

                                <div>

                                    <span id="recPick7" class="fw-bold text-dark me-2">--</span>

                                    <button class="btn btn-sm btn-outline-primary"
                                        onclick="copyRecommendation('å¿«ä¹8', 'é€‰ä¸ƒ å•å¼/å¤å¼', 'recPick7')">ğŸ“‹ å¤åˆ¶</button>

                                </div>

                            </li>

                        </ul>



                        <div class="card-header bg-success text-white mt-3">ğŸ”® æ™ºèƒ½è¿½å·æ¨è (ç»“åˆçƒ­å·+èµ°åŠ¿è§„å¾‹)</div>
                        <ul class="list-group list-group-flush">

                            <li class="list-group-item d-flex justify-content-between align-items-center">

                                <span><strong>æ™ºèƒ½é€‰äº”</strong> <small class="text-muted">çƒ­+é‡+é‚»</small></span>

                                <div>

                                    <span id="smartPick5" class="fw-bold text-success me-2">--</span>

                                    <button class="btn btn-sm btn-outline-success"
                                        onclick="copyRecommendation('å¿«ä¹8', 'æ™ºèƒ½é€‰äº”', 'smartPick5')">ğŸ“‹ å¤åˆ¶</button>

                                </div>

                            </li>

                            <li class="list-group-item d-flex justify-content-between align-items-center">

                                <span><strong>æ™ºèƒ½é€‰å…­</strong> <small class="text-muted">è¿½å·é¦–é€‰</small></span>

                                <div>

                                    <span id="smartPick6" class="fw-bold text-success me-2">--</span>

                                    <button class="btn btn-sm btn-outline-success"
                                        onclick="copyRecommendation('å¿«ä¹8', 'æ™ºèƒ½é€‰å…­', 'smartPick6')">ğŸ“‹ å¤åˆ¶</button>

                                </div>

                            </li>

                            <li class="list-group-item d-flex justify-content-between align-items-center">

                                <span><strong>æ™ºèƒ½é€‰ä¸ƒ</strong> <small class="text-muted">é«˜èƒœç‡å‹</small></span>

                                <div>

                                    <span id="smartPick7" class="fw-bold text-success me-2">--</span>

                                    <button class="btn btn-sm btn-outline-success"
                                        onclick="copyRecommendation('å¿«ä¹8', 'æ™ºèƒ½é€‰ä¸ƒ', 'smartPick7')">ğŸ“‹ å¤åˆ¶</button>

                                </div>

                            </li>

                        </ul>

                        <!-- æ–°å¢ï¼šæœºå™¨å­¦ä¹ æ¨è -->
                        <div class="card-header bg-info text-white mt-3">ğŸ¤– æœºå™¨å­¦ä¹ æ¨è (AIé¢„æµ‹)</div>
                        <ul class="list-group list-group-flush">

                            <li class="list-group-item d-flex justify-content-between align-items-center">

                                <span><strong>MLé€‰äº”</strong> <small class="text-muted">æ¦‚ç‡ä¼˜é€‰</small></span>

                                <div>

                                    <span id="mlPick5" class="fw-bold text-info me-2">--</span>

                                    <button class="btn btn-sm btn-outline-info"
                                        onclick="copyRecommendation('å¿«ä¹8', 'MLé€‰äº”', 'mlPick5')">ğŸ“‹ å¤åˆ¶</button>

                                </div>

                            </li>

                            <li class="list-group-item d-flex justify-content-between align-items-center">

                                <span><strong>MLé€‰ä¸ƒ</strong> <small class="text-muted">AIæ¨è</small></span>

                                <div>

                                    <span id="mlPick7" class="fw-bold text-info me-2">--</span>

                                    <button class="btn btn-sm btn-outline-info"
                                        onclick="copyRecommendation('å¿«ä¹8', 'MLé€‰ä¸ƒ', 'mlPick7')">ğŸ“‹ å¤åˆ¶</button>

                                </div>

                            </li>

                            <li class="list-group-item d-flex justify-content-between align-items-center">

                                <span><strong>MLé€‰å</strong> <small class="text-muted">è¦†ç›–é¢„æµ‹</small></span>

                                <div>

                                    <span id="mlPick10" class="fw-bold text-info me-2">--</span>

                                    <button class="btn btn-sm btn-outline-info"
                                        onclick="copyRecommendation('å¿«ä¹8', 'MLé€‰å', 'mlPick10')">ğŸ“‹ å¤åˆ¶</button>

                                </div>

                            </li>

                        </ul>



                        <div class="mt-2 text-center text-muted" style="font-size: 12px;">

                            * æ™ºèƒ½è¿½å·é¢å¤–æƒè¡¡äº†"è½å·"å’Œ"æ–œè¿å·"çš„æ¦‚ç‡<br>
                            * MLæ¨èåŸºäºéšæœºæ£®æ—æ¨¡å‹,åˆ†æ15+ç‰¹å¾ç”Ÿæˆ

                        </div>

                    </div>

                </div>





            </div>



            <div class="col-md-8">

                <div class="card">

                    <div class="card-header">ğŸ“Š 1-80å·å…¨å›¾é¢‘ç‡ (è¿‘50æœŸ)</div>

                    <div class="card-body">

                        <canvas id="freqChart" height="100"></canvas>

                    </div>

                </div>



                <!-- å†å²éªŒè¯å›é¡¾ (Layout Moved Here) -->

                <div class="card border-info mt-4">

                    <div class="card-header bg-info text-dark">ğŸ“ˆ å†å²æ¨èéªŒè¯å›é¡¾</div>

                    <div class="card-body p-0">

                        <div style="max-height: 500px; overflow-y: auto;">

                            <table class="table table-sm table-striped mb-0 text-center" style="font-size: 14px;">

                                <thead style="position: sticky; top: 0; background: white; z-index: 1;">

                                    <tr>

                                        <th>æœŸå·</th>

                                        <th>é€‰å››3èƒ†</th>
                                        <th>é€‰äº”4èƒ†</th>
                                        <th>æ™ºèƒ½é€‰äº”</th>

                                        <th>æ™ºèƒ½é€‰å…­</th>

                                        <th>æ™ºèƒ½é€‰ä¸ƒ</th>

                                    </tr>

                                </thead>

                                <tbody id="recVerifyTable">

                                    <tr>

                                        <td colspan="4">åŠ è½½ä¸­...</td>

                                    </tr>

                                </tbody>

                            </table>

                        </div>

                    </div>

                </div>

            </div>

        </div>



        <div class="row">

            <!-- å·¦ä¾§ï¼šçƒ­å·ä¸å†·å· -->

            <div class="col-md-4">

                <div class="card">

                    <div class="card-header">ğŸ“ˆ æœ€çƒ­å·ç  Top 10</div>

                    <div class="card-body">

                        <table class="table table-sm">

                            <thead>

                                <tr>

                                    <th>å·ç </th>

                                    <th>å‡ºç°æ¬¡æ•°</th>

                                    <th>çƒ­åº¦</th>

                                </tr>

                            </thead>

                            <tbody id="hotTable"></tbody>

                        </table>

                    </div>

                </div>

                <div class="card">

                    <div class="card-header">â„ï¸ æœ€å†·/é—æ¼å·ç  Top 10</div>

                    <div class="card-body">

                        <table class="table table-sm">

                            <thead>

                                <tr>

                                    <th>å·ç </th>

                                    <th>å‡ºç°æ¬¡æ•°</th>

                                    <th>çŠ¶æ€</th>

                                </tr>

                            </thead>

                            <tbody id="coldTable"></tbody>

                        </table>

                    </div>

                </div>

            </div>



            <!-- å³ä¾§ï¼šå¼€å¥–å†å² -->




            <div class="col-md-4">

                <div class="card">

                    <div class="card-header">ğŸ“… å†å²å¼€å¥–è®°å½•</div>

                    <div class="card-body" style="height: 500px; overflow-y: auto;">

                        <table class="table table-bordered table-striped" style="font-size: 12px;">

                            <thead>

                                <tr>

                                    <th>æœŸå·</th>

                                    <th>å¼€å¥–å·ç </th>

                                </tr>

                            </thead>

                            <tbody id="drawHistoryTable"></tbody>

                        </table>

                    </div>

                </div>

            </div>

        </div>



        <!-- æ–°å¢ï¼šå†å²é‡å·åˆ†æ -->

        <div class="row mt-3">

            <div class="col-12">

                <div class="card">

                    <div class="card-header">ğŸ”„ å†å²é‡å·èµ°åŠ¿åˆ†æ (è¿‘50æœŸ)</div>

                    <div class="card-body">

                        <div class="row">

                            <div class="col-md-9">

                                <canvas id="repeatChart" height="80"></canvas>

                            </div>

                            <div class="col-md-3" style="max-height: 300px; overflow-y: auto;">

                                <table class="table table-sm table-striped text-center" style="font-size: 12px;">

                                    <thead style="position: sticky; top: 0; background: white; z-index: 1;">

                                        <tr>

                                            <th>æœŸå·</th>

                                            <th>ä¸ªæ•°</th>

                                            <th>é‡å·è¯¦æƒ…</th>

                                        </tr>

                                    </thead>

                                    <tbody id="repeatTable"></tbody>

                                </table>

                            </div>

                        </div>

                    </div>

                </div>

            </div>

        </div>



        <!-- æ–°å¢ï¼šåŸºæœ¬èµ°åŠ¿å›¾ (é—æ¼åˆ†æ) -->

        <div class="row mt-3">

            <div class="col-12">

                <div class="card">

                    <div class="card-header">ğŸ“Š åŸºæœ¬èµ°åŠ¿å›¾ (01-80 é—æ¼åˆ†æ)</div>

                    <div class="card-body p-0">

                        <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">

                            <table class="table table-bordered text-center trend-table mb-0"
                                style="font-size: 12px; white-space: nowrap;">

                                <thead class="bg-light sticky-top" style="z-index: 2;">

                                    <tr id="trendHeader">

                                        <!-- JS å¡«å…… 01-80 -->

                                    </tr>

                                </thead>

                                <tbody id="trendBody"></tbody>

                                <tfoot id="trendFoot" class="bg-light font-weight-bold"
                                    style="position: sticky; bottom: 0; z-index: 2;"></tfoot>

                            </table>

                        </div>

                    </div>

                </div>

            </div>

        </div>

    </div>



    <script>
        freqChartInstance = null;


        let repeatChartInstance = null;



        document.addEventListener('DOMContentLoaded', function () {

            loadData();

            loadHistory();

        });



        function refreshData() {

            const num = document.getElementById('periodCount').value;

            // æ·»åŠ åŠ è½½çŠ¶æ€æç¤º

            const btn = document.querySelector('button');

            const originalText = btn.innerText;

            btn.innerText = 'âŒ› åŠ è½½ä¸­...';

            btn.disabled = true;



            fetch(`/api/refresh?num=${num}`)

                .then(response => {

                    if (!response.ok) {

                        return response.json().then(err => {

                            throw new Error(err.message || 'åˆ·æ–°å¤±è´¥');

                        });

                    }

                    return response.json();

                })

                .then(data => {

                    if (data.error) {

                        alert(data.message);

                        btn.innerText = originalText;

                        btn.disabled = false;

                    } else {

                        renderDashboard(data);

                        btn.innerText = originalText;

                        btn.disabled = false;

                        // æ›´æ–°å›¾è¡¨æ ‡é¢˜

                        const chartHeader = document.querySelector('#freqChart').closest('.card').querySelector('.card-header');

                        if (chartHeader) {

                            chartHeader.innerText = `ğŸ“Š 1-80å·å…¨å›¾é¢‘ç‡ (è¿‘${data.history.length}æœŸ)`;

                        }

                        // é‡æ–°åŠ è½½å†å²è®°å½•

                        loadHistory();

                    }

                })

                .catch(err => {

                    alert('åˆ·æ–°å¤±è´¥: ' + err.message + '\n\nè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•ã€‚');

                    btn.innerText = originalText;

                    btn.disabled = false;

                });

        }



        function loadData() {

            fetch('/api/data')

                .then(response => {

                    if (!response.ok) {

                        return response.json().then(err => {

                            throw new Error(err.message || 'æ•°æ®åŠ è½½å¤±è´¥');

                        });

                    }

                    return response.json();

                })

                .then(data => {

                    if (data.error) {

                        alert(data.message);

                    } else {

                        renderDashboard(data);

                        // é‡æ–°åŠ è½½å†å²éªŒè¯æ•°æ®

                        loadHistory();

                    }

                })

                .catch(err => {

                    console.error(err);

                    alert('æ•°æ®åŠ è½½å¤±è´¥: ' + err.message + '\n\nè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•ã€‚');

                });

        }



        function renderDashboard(data) {

            const analysis = data.analysis;

            const history = data.history;



            // 1. æ¸²æŸ“æ¨è

            document.getElementById('hotZone').innerText = analysis.recommendation.hot_zone;

            const dans = analysis.recommendation.dan_codes;

            let danHtml = '';

            dans.forEach(num => {

                danHtml += `<span class="ball ball-hot" style="width: 40px; height: 40px; line-height: 40px; font-size: 18px;">${num}</span>`;

            });

            document.getElementById('recommendDan').innerHTML = danHtml;



            // 1.1 æ¸²æŸ“çƒ­å·åŒå‡º

            const coOccur = analysis.co_occurrence;

            document.getElementById('topHotNums').innerText = coOccur.top_hot_nums.join(', ');



            const coBody = document.getElementById('coOccurTable');

            coBody.innerHTML = '';

            if (coOccur.history.length === 0) {

                coBody.innerHTML = '<tr><td colspan="3">è¿‘æœŸæœ€çƒ­å·ç å¾ˆå°‘åŒæ—¶å‡ºç°</td></tr>';

            } else {

                coOccur.history.forEach(item => {

                    const badgeClass = item.hits >= 4 ? 'bg-danger' : 'bg-warning text-dark';

                    coBody.innerHTML += `<tr>

                        <td>${item.period}</td>

                        <td><span class="badge ${badgeClass}">${item.hits}ä¸ª</span></td>

                        <td class="text-break">${item.hit_numbers.join(', ')}</td>

                    </tr>`;

                });

            }



            // 1.2 æ¸²æŸ“ç©æ³•æ¨è

            const strategies = analysis.strategies;

            document.getElementById('recPick4').innerText = strategies.pick4_3dan.join(', ');

            document.getElementById('recPick5Dan').innerText = strategies.pick5_4dan.join(', ');

            document.getElementById('recPick5').innerText = strategies.pick5_direct.join(', ');

            document.getElementById('recPick6').innerText = strategies.pick6_direct.join(', ');

            document.getElementById('recPick7').innerText = strategies.pick7_direct.join(', ');



            // 1.3 æ¸²æŸ“æ™ºèƒ½è¿½å·

            if (strategies.smart_pick5) {

                document.getElementById('smartPick5').innerText = strategies.smart_pick5.join(', ');

                document.getElementById('smartPick6').innerText = strategies.smart_pick6.join(', ');

                document.getElementById('smartPick7').innerText = strategies.smart_pick7.join(', ');

            }

            // 1.4 æ¸²æŸ“MLæ¨è(å¦‚æœå¯ç”¨)

            if (strategies.ml_pick5) {
                document.getElementById('mlPick5').innerText = strategies.ml_pick5.join(', ');
                document.getElementById('mlPick7').innerText = strategies.ml_pick7.join(', ');
                document.getElementById('mlPick10').innerText = strategies.ml_pick10.join(', ');
            } else {
                // MLæ¨¡å‹æœªåŠ è½½æ—¶æ˜¾ç¤ºæç¤º
                document.getElementById('mlPick5').innerText = 'æ¨¡å‹æœªè®­ç»ƒ';
                document.getElementById('mlPick7').innerText = 'æ¨¡å‹æœªè®­ç»ƒ';
                document.getElementById('mlPick10').innerText = 'æ¨¡å‹æœªè®­ç»ƒ';
            }



            // 1.4 æ›´æ–°æ‰€æœ‰å¡ç‰‡çš„æ ‡é¢˜ï¼Œæ˜¾ç¤ºå½“å‰æœŸæ•°

            const periodCount = data.history.length;

            const updateHeader = (elementId, titlePrefix) => {

                const el = document.getElementById(elementId);

                if (el) {

                    const header = el.closest('.card').querySelector('.card-header');

                    if (header) header.innerText = `${titlePrefix} (è¿‘${periodCount}æœŸ)`;

                }

            };



            // åˆ©ç”¨å·²æœ‰å…ƒç´ å®šä½å¡ç‰‡

            updateHeader('hotZone', 'ğŸ”¥ æå“èƒ†ç æ¨è');

            updateHeader('topHotNums', 'ğŸ¤ çƒ­å·åŒå‡ºåˆ†æ');

            updateHeader('recPick4', 'ğŸ† ç©æ³•ä¸“é¡¹æ¨è');



            // 2. æ¸²æŸ“å…¨å›¾é¢‘ç‡ Chart

            const labels = analysis.full_frequency.map(x => x[0]);

            const counts = analysis.full_frequency.map(x => x[1]);



            const ctxFreq = document.getElementById('freqChart').getContext('2d');

            if (freqChartInstance) freqChartInstance.destroy();



            freqChartInstance = new Chart(ctxFreq, {

                type: 'bar',

                data: {

                    labels: labels,

                    datasets: [{

                        label: 'å‡ºç°æ¬¡æ•°',

                        data: counts,

                        backgroundColor: counts.map(c => c >= 15 ? '#ff4757' : (c <= 5 ? '#535c68' : '#70a1ff')),

                        borderWidth: 0

                    }]

                },

                options: {

                    responsive: true,

                    scales: { y: { beginAtZero: true } }
                }
            });

            // 4. çƒ­å·è¡¨
            const hotBody = document.getElementById('hotTable');

            hotBody.innerHTML = '';

            analysis.most_common.forEach(([num, count]) => {

                hotBody.innerHTML += `<tr>

                    <td><span class="ball ball-hot">${num}</span></td>

                    <td><strong>${count}</strong></td>

                    <td><div class="progress" style="height: 5px;"><div class="progress-bar bg-danger" style="width: ${count / analysis.total_periods * 100}%"></div></div></td>

                </tr>`;

            });



            // 5. å†·å·è¡¨

            const coldBody = document.getElementById('coldTable');

            coldBody.innerHTML = '';

            analysis.least_common.forEach(([num, count]) => {

                coldBody.innerHTML += `<tr>

                    <td><span class="ball ball-cold">${num}</span></td>

                    <td>${count}</td>

                    <td><span class="badge bg-secondary">å†·</span></td>

                </tr>`;

            });



            // 6. å†å²è®°å½•è¡¨

            const histBody = document.getElementById('drawHistoryTable');

            histBody.innerHTML = '';

            history.forEach(item => {

                // åªæ˜¾ç¤ºå‰10ä¸ªå·ç æ¼”ç¤º

                const numsMin = item.numbers.slice(0, 10).join(' ') + ' ...';

                histBody.innerHTML += `<tr>

                    <td>${item.period}<br><small class="text-muted">${item.date}</small></td>

                    <td class="text-break" style="color: #d63031; font-weight: bold;">${item.numbers.join(' ')}</td>

                </tr>`;

            });



            // 7. æ¸²æŸ“é‡å·åˆ†æ

            if (analysis.repeat_analysis) {

                const repeats = analysis.repeat_analysis;

                const periods = repeats.map(r => r.period).reverse();

                const counts = repeats.map(r => r.count).reverse();



                // 7.1 æ¸²æŸ“å›¾è¡¨

                const ctxRepeat = document.getElementById('repeatChart').getContext('2d');

                if (repeatChartInstance) repeatChartInstance.destroy();



                repeatChartInstance = new Chart(ctxRepeat, {

                    type: 'line',

                    data: {

                        labels: periods,

                        datasets: [{

                            label: 'é‡å·ä¸ªæ•°',

                            data: counts,

                            borderColor: '#8854d0',

                            backgroundColor: 'rgba(136, 84, 208, 0.1)',

                            borderWidth: 2,

                            tension: 0.1,

                            fill: true,

                            pointRadius: 3,

                            pointBackgroundColor: counts.map(c => c >= 5 ? '#eb3b5a' : '#8854d0') // é«˜é‡å·çº¢è‰²æ ‡å‡º

                        }]

                    },

                    options: {

                        responsive: true,

                        scales: {

                            y: {

                                beginAtZero: true,

                                suggestedMax: 8,

                                grid: { color: '#f1f2f6' }

                            },

                            x: { grid: { display: false } }

                        }

                    }

                });



                // 7.2 æ¸²æŸ“è¡¨æ ¼

                const repeatBody = document.getElementById('repeatTable');

                repeatBody.innerHTML = '';

                // è¡¨æ ¼æ˜¾ç¤ºæœ€æ–°çš„åœ¨ä¸Šé¢ (ä¸éœ€è¦reverse)

                repeats.forEach(item => {

                    const badgeClass = item.count >= 5 ? 'bg-danger' : (item.count >= 4 ? 'bg-warning text-dark' : 'bg-secondary');

                    repeatBody.innerHTML += `<tr>

                        <td>${item.period}</td>

                        <td><span class="badge ${badgeClass}">${item.count}</span></td>

                        <td class="text-break text-muted">${item.numbers.join(' ')}</td>

                    </tr>`;

                });

            }



            // 8. æ¸²æŸ“åŸºæœ¬èµ°åŠ¿å›¾

            if (analysis.omission_data) {

                const omData = analysis.omission_data;

                const rows = omData.rows;

                const stats = omData.stats;

                const predScores = analysis.prediction_scores || [];



                // 8.1 æ¸²æŸ“è¡¨å¤´

                const tHeader = document.getElementById('trendHeader');

                tHeader.innerHTML = '<th style="position:sticky; left:0; background:#f8f9fa; z-index:3;">æœŸå·</th>';

                for (let i = 1; i <= 80; i++) {

                    const numStr = String(i).padStart(2, '0');

                    tHeader.innerHTML += `<th>${numStr}</th>`;

                }



                // 8.2 æ¸²æŸ“ä¸»ä½“

                const tBody = document.getElementById('trendBody');

                tBody.innerHTML = '';

                rows.forEach(row => {

                    let trHtml = `<tr><td style="position:sticky; left:0; background:#fff;">${row.period}</td>`;

                    for (let i = 1; i <= 80; i++) {

                        const cell = row.data[i];

                        if (cell.hit) {

                            trHtml += `<td><span class="trend-ball-hit">${String(i).padStart(2, '0')}</span></td>`;

                        } else {

                            trHtml += `<td><span class="trend-omission">${cell.omission}</span></td>`;

                        }

                    }

                    trHtml += '</tr>';

                    tBody.innerHTML += trHtml;

                });



                // 8.3 æ¸²æŸ“ç»Ÿè®¡ (å¯é€‰ï¼Œå¤ªé•¿äº†å…ˆç•¥è¿‡ï¼Œåªæ¸²æŸ“é¢„æµ‹è¡Œ)

                const tFoot = document.getElementById('trendFoot');

                tFoot.innerHTML = '';



                // é¢„æµ‹è¡Œ

                let predHtml = `<tr><td style="position:sticky; left:0; background:#e8f5e9; color:#2d3436;">ä¸‹æœŸé¢„æµ‹</td>`;

                // æå–å‰ 20 ä¸ªé«˜åˆ†å·ç 
                const top20Pred = predScores.slice(0, 20).map(x => parseInt(x.num));
                // æå–å‰ 10 ä¸ªï¼ˆé‡ç‚¹ï¼‰
                const top10Pred = predScores.slice(0, 10).map(x => parseInt(x.num));

                for (let i = 1; i <= 80; i++) {
                    if (top10Pred.includes(i)) {
                        // é‡ç‚¹æ¨èï¼šé‡‘è‰²è¾¹æ¡†
                        predHtml += `<td><span class="trend-predict-hit" style="border: 2px solid #ffc107; box-shadow: 0 0 5px #ffc107; transform: scale(1.1); font-weight: bold;" title="é‡ç‚¹å…³æ³¨">${String(i).padStart(2, '0')}</span></td>`;
                    } else if (top20Pred.includes(i)) {
                        predHtml += `<td><span class="trend-predict-hit" title="æ¨èå·ç ">${String(i).padStart(2, '0')}</span></td>`;
                    } else {
                        predHtml += `<td><span class="text-muted">-</span></td>`;
                    }
                }

                predHtml += '</tr>';

                tFoot.innerHTML = predHtml;

            }

            // æ¸²æŸ“é«˜çº§æ¨¡å¼è¯†åˆ«
            if (data.pattern_analysis) {
                renderPatternAnalysis(data.pattern_analysis);
            }

            function copyRecommendation(gameName, method, elementId) {

                const element = document.getElementById(elementId);

                if (!element) {

                    alert('æœªæ‰¾åˆ°æ¨èæ•°æ®');

                    return;

                }



                let numbers = element.innerText.trim();



                // å¦‚æœæ˜¯èƒ†ç æ¨èï¼Œéœ€è¦æå–å·ç çƒä¸­çš„æ•°å­—

                if (elementId === 'recommendDan') {

                    const balls = element.querySelectorAll('.ball');

                    if (balls.length > 0) {

                        numbers = Array.from(balls).map(ball => ball.innerText).join(' ');

                    }

                }



                if (numbers === '--' || numbers === 'åŠ è½½ä¸­...') {

                    alert('æ¨èæ•°æ®å°šæœªåŠ è½½ï¼Œè¯·ç¨åå†è¯•');

                    return;

                }



                // æ„å»ºå¤åˆ¶å†…å®¹ï¼šå½©ç§ æ–¹å¼ å·ç 

                const copyText = `${gameName} ${method}\nå·ç : ${numbers}`;



                // å¤åˆ¶åˆ°å‰ªè´´æ¿

                navigator.clipboard.writeText(copyText).then(() => {

                    // æ˜¾ç¤ºæˆåŠŸæç¤º

                    const button = event.target;

                    const originalText = button.innerHTML;

                    button.innerHTML = 'âœ… å·²å¤åˆ¶';

                    button.disabled = true;



                    setTimeout(() => {

                        button.innerHTML = originalText;

                        button.disabled = false;

                    }, 2000);

                }).catch(err => {

                    // é™çº§æ–¹æ¡ˆï¼šä½¿ç”¨ä¼ ç»Ÿæ–¹æ³•

                    const textArea = document.createElement('textarea');

                    textArea.value = copyText;

                    textArea.style.position = 'fixed';

                    textArea.style.opacity = '0';

                    document.body.appendChild(textArea);

                    textArea.select();



                    try {

                        document.execCommand('copy');

                        alert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼\n\n' + copyText);

                    } catch (err) {

                        alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶ï¼š\n\n' + copyText);

                    }



                    document.body.removeChild(textArea);

                });

            }
        }
        // åŠ è½½å†å²éªŒè¯æ•°æ®

        function loadHistory() {

            fetch('/api/history')

                .then(response => response.json())

                .then(data => {

                    const tbody = document.getElementById('recVerifyTable');

                    if (!tbody) {

                        console.error('æ‰¾ä¸åˆ° ID ä¸º recVerifyTable çš„å…ƒç´ ');

                        return;

                    }

                    tbody.innerHTML = '';



                    if (!data || data.length === 0) {

                        tbody.innerHTML = '<tr><td colspan="4">æš‚æ— å†å²è®°å½•</td></tr>';

                        return;

                    }



                    data.forEach(item => {

                        const strategiesToCheck = ['pick4_3dan', 'pick5_4dan', 'smart_pick5', 'smart_pick6', 'smart_pick7'];

                        let rowHtml = `<td>${item.period}</td>`;



                        strategiesToCheck.forEach(key => {

                            let rec = item.recommendations ? item.recommendations[key] : null;

                            let val = item.validation ? item.validation[key] : null;



                            let content = '<span class="text-muted">--</span>';



                            if (rec) {

                                let numsStr = Array.isArray(rec) ? rec.join(' ') : String(rec);

                                // éªŒè¯ä¿¡æ¯

                                if (val) {

                                    let badgeColor = 'bg-secondary';

                                    if (val.hit_count >= 3) badgeColor = 'bg-warning text-dark';

                                    if (val.hit_count >= 4) badgeColor = 'bg-danger';



                                    content = `

                                        <div>

                                            <span class="badge ${badgeColor} mb-1">${val.hit_count}ä¸­</span>

                                            <br>

                                            <small class="text-muted" style="font-size: 10px;">${numsStr}</small>

                                        </div>

                                    `;

                                } else if (item.actual_result) {

                                    content = `

                                        <div>

                                            <span class="text-muted">ç­‰å¾…è®¡ç®—</span>

                                            <br>

                                            <small class="text-muted" style="font-size: 10px;">${numsStr}</small>

                                        </div>

                                    `;

                                } else {

                                    content = `

                                        <div>

                                            <span class="badge bg-secondary mb-1">å¾…å¼€å¥–</span>

                                            <br>

                                            <small class="text-muted" style="font-size: 10px;">${numsStr}</small>

                                        </div>

                                    `;

                                }

                            }

                            rowHtml += `<td>${content}</td>`;

                        });



                        const tr = document.createElement('tr');

                        tr.innerHTML = rowHtml;

                        tbody.appendChild(tr);

                    });

                })

                .catch(err => {

                    console.error('åŠ è½½å†å²å¤±è´¥:', err);

                    const el = document.getElementById('recVerifyTable');

                    if (el) el.innerHTML = '<tr><td colspan="4" class="text-danger">åŠ è½½å¤±è´¥</td></tr>';

                });

        }



        // --- æ‰‹åŠ¨å½•å…¥é€»è¾‘ ---



        function openManualInputModal() {

            const container = document.getElementById('manualInputs');

            if (container.querySelectorAll('input').length === 0) {

                container.innerHTML = '';

                for (let i = 0; i < 20; i++) {

                    container.innerHTML += `

                        <div class="col-3 col-sm-2">

                             <input type="number" class="form-control text-center manual-num" min="1" max="80" placeholder="${i + 1}">

                        </div>

                    `;

                }

            }



            fetch('/api/data').then(r => r.json()).then(d => {

                if (d.history && d.history.length > 0) {

                    const lastPeriod = parseInt(d.history[0].period);

                    document.getElementById('manualPeriod').value = lastPeriod + 1;

                }

            });



            new bootstrap.Modal(document.getElementById('importModal')).show();

        }



        // æäº¤æ•°æ®

        function submitManualData() {

            const period = document.getElementById('manualPeriod').value;

            const inputs = document.querySelectorAll('.manual-num');

            const numbers = Array.from(inputs).map(input => input.value.padStart(2, '0')).filter(v => v !== '00' && v !== '');



            if (!period) {

                alert('è¯·è¾“å…¥æœŸå·ï¼');

                return;

            }

            if (numbers.length !== 20) {

                alert(`å·ç æ•°é‡ä¸æ­£ç¡®ï¼å½“å‰åªæœ‰ ${numbers.length} ä¸ªæœ‰æ•ˆçš„1-80å·ç ï¼Œéœ€è¦20ä¸ªã€‚`);

                return;

            }



            // å‘é€è¯·æ±‚

            fetch('/api/submit_data', {

                method: 'POST',

                headers: { 'Content-Type': 'application/json' },

                body: JSON.stringify({ period, numbers })

            })

                .then(res => res.json())

                .then(data => {

                    if (data.success) {

                        alert('âœ… å½•å…¥æˆåŠŸï¼');

                        // å…³é—­å¼¹çª—

                        const modalEl = document.getElementById('importModal');

                        const modal = bootstrap.Modal.getInstance(modalEl);

                        modal.hide();



                        // åˆ·æ–°é¡µé¢æ•°æ®

                        renderDashboard(data);

                        loadHistory();

                    } else {

                        alert('âŒ å¤±è´¥: ' + data.message);

                    }

                })

                .catch(err => {

                    alert('âŒ è¯·æ±‚é”™è¯¯: ' + err.message);

                });

        }

    </script>

    <!-- å½•å…¥å¼¹çª— -->

    <div class="modal fade" id="importModal" tabindex="-1">

        <div class="modal-dialog modal-lg">

            <div class="modal-content">

                <div class="modal-header">

                    <h5 class="modal-title">âœï¸ æ‰‹åŠ¨å½•å…¥å¼€å¥–æ•°æ®</h5>

                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>

                </div>

                <div class="modal-body">



                    <hr>



                    <div class="row mb-3">

                        <div class="col-md-4">

                            <label class="form-label">æœŸå·</label>

                            <input type="text" class="form-control" id="manualPeriod" placeholder="ä¾‹å¦‚ 2026020">

                        </div>

                    </div>



                    <label class="form-label">å¼€å¥–å·ç æ ¡å¯¹ (éœ€20ä¸ª)</label>

                    <div class="row g-2" id="manualInputs">

                        <!-- JS ç”Ÿæˆ 20 ä¸ªè¾“å…¥æ¡† -->

                    </div>

                </div>

                <div class="modal-footer">

                    <div class="me-auto text-muted" id="ocrDebugInfo" style="font-size: 10px;"></div>

                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>

                    <button type="button" class="btn btn-primary" onclick="submitManualData()">âœ… ç¡®è®¤æäº¤</button>

                </div>

            </div>

        </div>

    </div>


    <!-- é«˜çº§æ¨¡å¼è¯†åˆ«å¡ç‰‡ - æ’å…¥åˆ°ç°æœ‰å¡ç‰‡ä¹‹å -->

    <div class="card mb-4">

        <div class="card-header bg-info text-white">

            <h5 class="mb-0">ğŸ” é«˜çº§æ¨¡å¼è¯†åˆ«</h5>

        </div>

        <div class="card-body">

            <!-- è¿å·åˆ†æ -->

            <div class="mb-4">

                <h6 class="text-primary">ğŸ“Š è¿å·åˆ†æ</h6>

                <div id="consecutiveAnalysis" class="p-3 bg-light rounded">

                    <p class="text-muted">åŠ è½½ä¸­...</p>

                </div>

            </div>



            <!-- åŒå°¾å·åˆ†æ -->

            <div class="mb-4">

                <h6 class="text-primary">ğŸ¯ åŒå°¾å·åˆ†æ</h6>

                <div id="sameTailAnalysis" class="p-3 bg-light rounded">

                    <p class="text-muted">åŠ è½½ä¸­...</p>

                </div>

            </div>



            <!-- ACå€¼åˆ†æ -->

            <div class="mb-4">

                <h6 class="text-primary">ğŸ“ˆ ACå€¼åˆ†æ</h6>

                <div id="acValueAnalysis" class="p-3 bg-light rounded">

                    <p class="text-muted">åŠ è½½ä¸­...</p>

                </div>

            </div>

        </div>

    </div>



    <script>

        // æ¸²æŸ“æ¨¡å¼åˆ†æç»“æœ


        // æ¸²æŸ“æ¨¡å¼åˆ†æç»“æœ
        function renderPatternAnalysis(pattern) {
            if (!pattern) return;

            // 1. æ¸²æŸ“è¿å·åˆ†æ
            if (pattern.consecutive) {
                const consecutive = pattern.consecutive;
                let html = `
                <div class="mb-2"><strong>${consecutive.summary || ''}</strong></div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <h6>è¿å·ç»Ÿè®¡</h6>
                        <ul class="list-unstyled">
                            ${(consecutive.stats ? Object.entries(consecutive.stats) : []).map(([key, value]) => `<li>â€¢ ${key}: <span class="badge bg-secondary">${value}æ¬¡</span></li>`).join('')}
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6>æ¨èè¿å·ç»„åˆ</h6>
                        ${consecutive.recommended && consecutive.recommended.length > 0 ?
                        consecutive.recommended.map(group => `<div class="mb-2">${group.map(n => `<span class="badge bg-success me-1">${n}</span>`).join('')}</div>`).join('')
                        : '<p class="text-muted">æš‚æ— æ¨è</p>'}
                    </div>
                </div>
                ${consecutive.recent_examples && consecutive.recent_examples.length > 0 ? `
                    <div>
                        <h6>è¿‘æœŸè¿å·ç¤ºä¾‹</h6>
                        <div class="table-responsive">
                            <table class="table table-sm table-bordered">
                                <thead><tr><th>æœŸå·</th><th>è¿å·</th></tr></thead>
                                <tbody>
                                    ${consecutive.recent_examples.map(ex => `<tr><td>${ex.period}</td><td>${ex.numbers.map(n => `<span class="badge bg-info me-1">${n}</span>`).join('')}</td></tr>`).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>` : ''}
            `;
                const el = document.getElementById('consecutiveAnalysis');
                if (el) el.innerHTML = html;
            }

            // 2. æ¸²æŸ“åŒå°¾å·åˆ†æ
            if (pattern.same_tail) {
                const sameTail = pattern.same_tail;
                let html = `
                <div class="mb-2"><strong>${sameTail.summary || ''}</strong></div>
                <div class="row">
                    <div class="col-md-6">
                        <h6>çƒ­å°¾ç»Ÿè®¡</h6>
                        <ul class="list-unstyled">
                            ${(sameTail.stats ? Object.entries(sameTail.stats) : []).slice(0, 5).map(([tail, count]) => `<li>â€¢ å°¾æ•°${tail}: <span class="badge bg-danger">${count}æ¬¡</span></li>`).join('')}
                        </ul>
                    </div>
                    <div class="col-md-6">
                         <h6>æ¨èåŒå°¾å·</h6>
                         ${sameTail.recommended && sameTail.recommended.length > 0 ?
                        sameTail.recommended.map(group => `<div class="mb-2">${group.map(n => `<span class="badge bg-primary me-1">${n}</span>`).join('')}</div>`).join('')
                        : '<p class="text-muted">æš‚æ— æ¨è</p>'}
                    </div>
                </div>
            `;
                const el = document.getElementById('sameTailAnalysis');
                if (el) el.innerHTML = html;
            }

            // 3. æ¸²æŸ“ACå€¼åˆ†æ
            if (pattern.ac_value) {
                const ac = pattern.ac_value;
                let html = `
                <div class="mb-2"><strong>${ac.summary || ''}</strong></div>
                <div class="row">
                    <div class="col-md-6">
                        <h6>è¿‘æœŸACå€¼</h6>
                        <p>${(ac.recent_values || []).slice(0, 10).join(', ')}</p>
                    </div>
                    <div class="col-md-6">
                        <h6>æ¨èACå€¼</h6>
                         <p class="text-success font-weight-bold">${ac.recommended_range || ''}</p>
                    </div>
                </div>
            `;
                const el = document.getElementById('acValueAnalysis');
                if (el) el.innerHTML = html;
            }
        }
    </script>
</body>



</html>